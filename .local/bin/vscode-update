#!/bin/zsh
cd /tmp/
echo "Installing Visual Studio Code"

echo "[1/6] Fetching binary..."
wget https://update.code.visualstudio.com/latest/linux-x64/stable -O code.tar.gz

echo "\n[2/6] Extracting tarball..."
tar xpvf code.tar.gz

echo "\n[3/6] Copying files..."
sudo mv -v VSCode-linux-x64 /opt/visual-studio-code-bin

echo "\n[4/6] Adding run script..."
echo "#!/usr/bin/env sh
#
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.

# test that VSCode wasn't installed inside WSL
if grep -qi Microsoft /proc/version && [ -z \"$DONT_PROMPT_WSL_INSTALL\" ]; then
	echo \"To use Visual Studio Code with the Windows Subsystem for Linux, please install Visual Studio Code in Windows and uninstall the Linux version in WSL. You can then use the \`code\` command in a WSL terminal just as you would in a normal command prompt.\" 1>&2
	printf \"Do you want to continue anyway? [y/N] \" 1>&2
	read -r YN
	YN=$(printf '%s' \"$YN\" | tr '[:upper:]' '[:lower:]')
	case \"$YN\" in
		y | yes )
		;;
		* )
			exit 1
		;;
	esac
	echo \"To no longer see this prompt, start Visual Studio Code with the environment variable DONT_PROMPT_WSL_INSTALL defined.\" 1>&2
fi

# If root, ensure that --user-data-dir or --file-write is specified
if [ \"$(id -u)\" = \"0\" ]; then
	for i in \"$@\"
	do
		case \"$i\" in
			--user-data-dir | --user-data-dir=* | --file-write )
				CAN_LAUNCH_AS_ROOT=1
			;;
		esac
	done
	if [ -z $CAN_LAUNCH_AS_ROOT ]; then
		echo \"You are trying to start Visual Studio Code as a super user which isn't recommended. If this was intended, please specify an alternate user data directory using the \`--user-data-dir\` argument.\" 1>&2
		exit 1
	fi
fi

if [ ! -L \"$0\" ]; then
	# if path is not a symlink, find relatively
	VSCODE_PATH=\"$(dirname \"$0\")/..\"
else
	if command -v readlink >/dev/null; then
		# if readlink exists, follow the symlink and find relatively
		VSCODE_PATH=\"$(dirname \"$(readlink -f \"$0\")\")/..\"
	else
		# else use the standard install location
		VSCODE_PATH=\"/usr/share/code\"
	fi
fi

ELECTRON=\"$VSCODE_PATH/code\"
CLI=\"$VSCODE_PATH/resources/app/out/cli.js\"
ELECTRON_RUN_AS_NODE=1 \"$ELECTRON\" \"$CLI\" \"$@\"
exit $?
" > /tmp/code
sudo mv -v /tmp/code /usr/bin/code

echo "\n[5/6] Creating desktop files..."
mkdir -pv /usr/share/applications

echo "[Desktop Entry]
Name=Visual Studio Code
Comment=Code Editing. Refined.
GenericName=Text Editor
Exec=/home/michael/.local/bin/VSCode-linux-x64/code --no-sandbox --unity-launch %F
Icon=/home/michael/.local/bin/VSCode-linux-x64/resources/app/resources/linux/code.png
Type=Application
StartupNotify=false
StartupWMClass=code
Categories=Utility;TextEditor;Development;IDE;
MimeType=text/plain;inode/directory;
Actions=new-empty-window;
Keywords=vscode;

[Desktop Action new-empty-window]
Name=New Empty Window
Exec=/home/michael/.local/bin/VSCode-linux-x64/code --no-sandbox --new-window %F
Icon=/home/michael/.local/bin/VSCode-linux-x64/resources/app/resources/linux/code.png
" > /tmp/visual-studio-code.desktop
sudo mv -v /tmp/visual-studio-code-bin.desktop /usr/share/applications

echo "[Desktop Entry]
Name=Visual Studio Code - URL Handler
Comment=Code Editing. Redefined.
GenericName=Text Editor
Exec=/home/michael/.local/bin/VSCode-linux-x64/code --no-sandbox --open-url %U
Icon=/home/michael/.local/bin/VSCode-linux-x64/resources/app/resources/linux/code.png
Type=Application
NoDisplay=true
StartupNotify=true
Categories=Utility;TextEditor;Development;IDE;
MimeType=x-scheme-handler/vscode;
Keywords=vscode;
" > /tmp/visual-studio-code-url-handler.desktop
sudo mv -v /tmp/visual-studio-code-bin-url-handler.desktop /usr/share/applications

echo "\n[6/6] Cleaning up..."
rm -rvf VSCode-linux-x64 code.tar.gz

echo "Visual Studio Code successfully installed!"
